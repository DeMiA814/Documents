# CI/CDとは
CI/CDツールの比較を行う上で、まずCI/CDとは何かをここで示します。
CI/CDとは「Continuous Integration/Continuous Delivery(Deployment)」の略で、日本語では「継続的インテグレーション/継続的デリバリー」と訳されます。
具体的には、コードの変更などのイベントに応じて、コードのテストやビルド、デプロイを自動的に行い、コーディング以外の作業を削減して、人的ミスを減らすとともにアップデートを高速にするための仕組みのことで、アジャイル開発の場面でよく活用されます。
多くの場合これらのステップは複数のツールを利用して構築され、そのようなフローをCI/CDパイプラインと呼びます。

現状、弊社にはデプロイや環境構築の属人化が進んでその人以外環境を触れない、テストを行わない、セキュリティへの意識が薄いなどの悪癖が蔓延しています。
そこで、ここでは、パイプラインで用いられるような、またそのほかにも活用されそうな技術やツールを紹介・比較していきます。プロジェクトの技術選定の参考になれば幸いです。

![enter image description here](https://www.ashisuto.co.jp/enishi/service_quality/__icsFiles/afieldfile/2021/04/13/cicd-line.png)

# ツールの比較

## CIツール
まずはCIツール、つまりデプロイに至るまでのビルドやテストまでの自動化を行うツールについての比較を行います。
![enter image description here](https://www.techmatrix.co.jp/product/cisolution/thhp7i0000002h2k-img/jenkins-cycle.png)

### Circle CI
（特に利用者数などのデータは出てこなかったので断言はできないですが）おそらくCIツールの中で最も有名なツールです。
SaaSのクラウド形式で提供され、設定などはyml形式で記述するため導入・運用コストが低く、学習コストもかからない一方で、コンテナ数を増やすと1つにつき50ドルかかるので、継続的に利用すると金銭的コストがかかります。
実装では、Circle CIのGUIから管理するGitリポジトリ、サーバーとSSH鍵を登録し、Gitに.circleci/config.ymlというファイルを設置するとこれを自動的に読み込んでよしなに実行してくれます。
Docker、Linux VM、Windows VM、Mac VMの環境が用意されています（が、Dockerがデファクトスタンダードなようです）。
CIとは言っていますが、トリガーを元に設定された処理を実行するというだけなので、書き方次第ではデプロイまでも自動化することができます。
既存の多くのナレッジを利用できることもメリット。
https://circleci.com/ja/

### Jenkins
Circle CIに並んで広く利用されているCIツール。Circle CIがクラウドからサービスを提供しているのに対してこちらは環境に直接導入するオンプレ型のため環境構築の手間がかかり、多少の知識が要求される一方で、同時に30ジョブまでなら無料という料金設定と、数多くのプラグインが用意されているのでさまざまな環境に柔軟に対応できるのが特徴。Djangoにもパッケージが存在しています。
なお、こちらはDockerを前提とはしていません。
実装ではプロジェクトにテストの処理などを記述した上でJenkinsをインストールし、実行環境やタイミング、結果の出力先などの細かな設定を行なっていくことになります。GUIとCLIの両方が提供されています。
デプロイ機能はないので、後述するCodeCommitなどにビルドを送信するか、実行サーバーと別にJenkins用のサーバーを構築し、そこでビルドしたアプリを実行サーバーに反映する、というような構成になります。
Circle CIに比べると劣るものの、こちらにもナレッジは充実しています。
ちなみに開発者は日本人。
https://www.jenkins.io/

### AWS CodeCommit, CodeBuild, CodeDeploy, CodePipeline
AWSが提供しているCI/CDパイプラインを全てまとめたサービス。CodeCommitがGitのトリガーやプルリクエストなどGitHubが現状になっているようなGitの管理、CodeBuildがコードのビルドとテスト、CodeDeployはビルドの本番環境へのデプロイ、CodePipelineがこれらをまとめたパイプライン処理の構築を担います。
GitHubやCircle CIなど、それぞれのパートを別のツールを用いて構築することも可能。ほとんどがAWSのGUI上で完結するので、AWSを用いたプロジェクトであれば当然もっとも手軽な手段となります。また、コンテナへの依存もありません。
AWSといえば高額なイメージがありますが、CodeCommitは条件付き無料でCodeDeployは完全無料、CodeBuildは100分まで無料でその後も1分0.004ドル、CodePipelineは1パイプラインにつき1ドルと、全体的に安価なようなので一度試してみる価値はあり。テストしたら追記します。

### kubernetes
「クバネティス」「クーベネティス」と読み、間の8文字を省略して「k8s」、または「kube」と略されます。 
kubernetesは正しくはCI/CDツールではなくコンテナオーケストレーションツールというものであり、Dockerコンテナの設定管理やスケーリング、障害復旧、ビルド、テスト、デプロイを自動化するためのツールです。つまり、コンテナを用いたプロジェクトの管理全般を司るツールであり、その中の機能としてCI/CDパイプラインが存在すると言った位置付けです。
![enter image description here](https://www.redhat.com/cms/managed-files/kubernetes-diagram-2-824x437.png)
kubernetesでは、1つ以上のコンテナをまとめたPodという単位でアプリを管理し、1つのアプリを複数Podで起動して冗長性を確保したり、Pod間で連携をとるマイクロサービス的な運用で真価を発揮するため、それなりに規模の大きいアプリで有用になります。
ただし、もちろん小さな規模のアプリでも使用することもできます。
オンプレにインストールする方法とAWSやGCP、Azureが提供するクラウドサービスを利用する方法があり、機能が多く専門知識も多いため学習コストはかなり高いものの、kubernetesが使えればコンテナを用いたプロジェクトにおける全ての管理がこれで完結するという強力なツールです。他のCI/CDツールと連携してより柔軟な設定を行うことも可能です。
https://kubernetes.io/ja/

### GitHub Actions
GitHubが提供する、プルリクエストや時間などさまざまなトリガーでイベントを設定することのできるCI/CDツールで、コンテナに依存することなくビルドからデプロイまでのパイプラインをこれのみで構築できます。またクラウド上で動作するため環境構築の必要もなくGitHub上のGUIのみで設定が完結するため、導入コストも非常に低く、テストの結果をGitHubに表示するなどの連携も優秀です。
デメリットとしては、プライベートリポジトリの無料利用枠は月に500MBで、それ以降の容量もシビアで、アカウントのアップグレードか時間制の従量課金がほぼ必須なため、金額的なコストが嵩むと考えられます。
https://github.co.jp/features/actions

### GitLab CI/CD
こちらもGitのトリガーでイベントを設定できるCI/CDツールになります。
Dockerが推奨されており、サーバー上のGitLab RunnerがDocker Engineに対して処理を実行し、コンテナに反映するというしくみです。
![enter image description here](https://satolabo.net/wp-content/uploads/2019/11/00_structure_design.jpg)
他のDockerを使ったCI/CDツールと比較すると、kubernetesよりも原理が単純なため扱いやすくCircle CIよりも安価、Jenkinsと違ってデプロイまでができるというメリットがありますが、GitHubが使えないというのが非常に大きなデメリットになります。
https://docs.gitlab.com/ee/ci/

### Bitrise
モバイルアプリに特化したPaaSのクラウド型CI/CDサービスです。FlutterのCI/CDに関しての文献があまりに乏しく、内容がまともに充実していたのがこれについてくらいでした。
アプリのビルド、テスト、特定のメールアドレスへのアプリファイルの送信、ストアへの公開、アップデートの通知などを全て自動で行ってくれます。
料金設定も無料枠でmacでのビルドが月150分まで、月額31.5ドルのプランにアップグレードすれば月25000分までと比較的良心的です。
https://www.bitrise.io/
数少ない文献はこちら
https://qiita.com/yamatatsu10969/items/3590cc78c62e92718f28#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB

## IaC
Infrastructure as Codeの略称で、環境構築をサーバーにSSHしてコマンドを実行する従来のやり方でなく、1つのファイルに宣言的に記述し、これを実行することで自動的に環境構築を行うことのできるツールのことです。
CI/CDの領域ではないのですが、保守性の話題に関連して紹介しておきます。現状では以下で紹介するAnsibleとterraformがデファクトスタンダードとなっています。

### Ansible
サーバーの構築に際して、必要なソフトウェアの導入やこれらの設定などを自動化することのできるツールです。yamlで記述するため学習コストが低く、原理も単純なため理解しやすいツールです。
普段nginxの設定などサーバーの各所に散らばりがちな設定を一箇所にまとめることができます。
https://www.ansible.com/

### terraform
AWS、GCP、Azureなど主要なクラウドサービスのインスタンスやネットワークなどインフラの構築をコードの形式で記述し実行することができるほか、既存のインフラ設定を元に設定を構築できるツールです。
こちらについても設定を一箇所にまとめることで保守性の担保につながります。
https://www.terraform.io/

### docker
docker自体はIaCのためのツールではなく仮想化のためのツールなのですが、その特性上環境構築の処理をファイルに宣言的に記述することから、実質IaCとしての役割も部分的に果たすことができます。
こちらについては詳しく紹介しているドキュメントを作成していますので、そちらをご覧ください。

## 踏み台サーバー
こちらについてもCI/CDに直接絡むわけではないのですが、保守性を上げるために一般的に用いられてる手法ですのでこちらで紹介させていただきます。
踏み台サーバーはBastion serverなどとも呼ばれ、どこかのサーバーにアクセスするために経由することになるサーバーのことを指します。

![enter image description here](https://cdn-ak.f.st-hatena.com/images/fotolife/c/cmpokuma/20200507/20200507195757.png)

アプリなどが載っているサーバーへアクセスする際に踏み台サーバーからのアクセスのみを許可し、必ずここを経由しなければいけないフローにすることで
・実行サーバーのセキュリティが堅固になりリスクが低減する
・踏み台サーバーのセキュリティを一元的に管理すれば良いので、保守性が向上する
・万が一ネットワーク内に侵入された場合でも、踏み台サーバーのログを辿ればよいので追跡が容易になる
といったメリットが得られます。
