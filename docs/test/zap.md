# セキュリティテストツール ZAP の使い方

- 概要
- 使用ツール
- インストール
- 手順

## 概要

zap を使用してセキュリティの観点で脆弱な部分を発見する。
本番環境を想定したテストなのでコードがある程度完成して今後大きな変更がなくなったタイミングでテストを行う。 **(他のサイトを攻撃しないように十分に気をつける)**

<image width="500" src="./images/owasp_zap.png">

## 使用ツール

1. [zap](https://www.zaproxy.org/)

## インストール

1. owsp zap
2. Firefox

### owsp zap

[ダウンロードページ](https://www.zaproxy.org/download/)から自分の pc に対応したものをダウンロード

### Firefox

攻撃の設定がしやすいという理由で Firefox 経由でテストを行う。また Firefox でテストの紹介をしている記事がネット上に多いので情報量の観点で採用。[ダウンロードページ](https://www.mozilla.org/en-US/firefox/new/)

## 手順

1. プロジェクト保存設定
2. zap と Firefox のプロキシ連携
3. 暗号化通信（SSL/TLS）設定
4. 診断モード設定
5. 診断対象の設定
6. 診断対象の調査
7. 攻撃ポリシーの作成
8. 攻撃の実行
9. 結果の確認

### 1.プロジェクトの保存設定

起動後以下のようなモーダルが出てくるが、「継続的に保存せず、必要に応じてセッションを保存」を選択する。逆にセッションを保存する場合は攻撃自体が保存されるわけではなく診断結果が保存されるだけだ。必要に応じて保存できる今回のオプションが最も使い勝手が良い。<br>
<image width="500" src="./images/zap_initial.jpeg">
<br>

### 2.zap と Firefox のプロキシ連携

まずは zap 側で\[ツール\]>\[オプション\]>\[ローカル・プロキシ\]を設定する。<br>
アドレスとポートを設定するが、今回はアドレスは"localhost"ポートは"50000"にした。<br>
※ポート番号は Dynamic Port Number の 49152~65535 が良い<br>
<image width="500" src="./images/zap_local_proxy.jpeg">

<br>
次に Firefox 側で zap で設定したローカル・プロキシを使用するようにする。<br>
\[設定\]>\[一般\]>\[ネットワーク設定\]にある「接続設定」ボタンをクリックしてインターネット接続設定画面を表示する。以下のように「手動でプロキシーを設定する」のラジオボタンを選択し zap で登録したアドレスとポートを登録する。<br>
<image width="500" src="./images/firefox_proxy.png">
<br>

### 3.暗号化通信（SSL/TLS）設定

zap で\[ツール\]>\[オプション\]>\[ダイナミック SSL 証明書\]を開き、「保存」ボタンをクリックして保存。この時保存したファイルは次の Firefox 側の設定で使う。<br>
<image width="500" src="./images/dynamic_ssl.jpeg">

Firefox で\[設定\]>\[一般\]>\[プライバシーとセキュリティ\]>\[セキュリティ\]>\[証明書\]にある「証明書を表示」をボタンをクリックし「証明書マネージャー」を開く。「認証局証明書」のタブを選択し「インポート」をクリック。証明書のアップロードを要求されるので zap 側でダウンロードした証明書を選択する。「この認証局によるウェブサイトの識別を信頼する」にチェックを入れて「OK」をクリックし、証明書の一覧に"OWASP Root CA"が追加されていれば成功。<br>
<image width="500" src="./images/firefox_security.png">
<image width="500" src="./images/firefox_certificate_manager.png">
<br>

### 4.診断モードの設定

診断モードは zap トップ画面の左上のプルダウンで設定でき「プロテクトモード」にする。このモードにすることで攻撃の範囲を確実に自分が登録した URL の範囲に限定できる。
「セーフモード」ではクローリングや動的スキャンができない。編集中などはこのモードでも良い。「標準モード」、「攻撃モード」は外部のサイトも攻撃する可能性があり意図せず攻撃を行ってしまう場合があるので極力利用しない。どうしても必要な場合は安全性を検討する。<br>

<image width="500" src="./images/zap_mode.jpeg">
<br>

### 5.診断対象の設定

上記の設定を終えた状態で Firefox から診断対象にしたいサイトにアクセスすると zap トップ画面左上の「サイト」にそのサイトの URL が追加される。そのサイトを右クリックして\[コンテキストに含める\]>\[New Context\]を選択する。確認画面が表示されるので「OK」をクリック。「コンテキスト」に対象のサイトが追加されていることを確認する。また、的のような赤い丸のボタンをクリックするとコンテキストに含まれるものだけが表示されるようになるので見やすくなる。これで診断対象の URL を zap に認識させた。<br>
<image width="500" src="./images/zap_get_site.jpeg">
<image width="500" src="./images/zap_new_context.jpeg">
<image width="500" src="./images/zap_target.jpeg">
<br>

### 6.診断対象の調査

診断対象にどのようなページが含まれているかを解析する。このときに用いるのが「スパイダー」という機能だ。「コンテキスト」に存在する対象のサイトを選択した状態で\[ツール\]>\[オプション\]>\[スパイダー\]を開き、「クロールする最大の深さ」を 10「並列スキャンスレッド数」を 1 に設定する。この数値は基本的にこれで事足りるだろうという基準なので必要に応じて変更できる。これで「スパイダー」のメタ設定が完了したので「コンテキスト」の対象サイトを右クリックして「スパイダー」をクリックする。確認画面が表示されるので「開始位置」と「スコープ」があっているかを確認して「スキャンを開始」をクリック。「スパイダー」が実行され zap トップ画面下側に「スパイダー」の項目が追加される。<br>
<image width="500" src="./images/spider_detail.png">
<image width="500" src="./images/zap_target_menu.png">
<br>

### 7.攻撃ポリシーの作成

「コンテキスト」内に存在する対象サイトを選択した状態でツールバーの\[ポリシー\]>\[スキャンポリシーの選択\]をクリック。「追加」を選択することで攻撃の詳細を指定することができる。各項目で「閾値」と「強度」を調整できる。設定が完了したら「OK」で作成を完了させる。ここの項目で詳細を設定できるが zap では標準で「Default Policy」が存在するので基本的には作成しなくてよい。<br>
<image width="500" src="./images/zap_scan_policy_detail.jpeg">
<br>

### 8.攻撃の実行

「コンテキスト」内に存在する対象サイトで右クリックして「動的スキャン」をクリックすると確認画面が表示されるので詳細を確認する。「詳細オプションを表示」のラジオボタンを押して詳細オプションを表示させるとタブが増える。そのタブの項目ごとに設定ができるが、作成したスキャンポリシーを使用したいときはその中の「ポリシー」で選択する。確認ができたら「スキャンを開始」をクリックして攻撃を開始する。<br>
<image width="500" src="./images/zap_target_menu.png">
<image width="500" src="./images/zap_dynamic_scan_detail.png">
<br>

### 9.結果の確認

スキャンが完了したら zap トップ画面下部の「アラート」タブに脆弱性が発見された部分については報告が残る。クリックすることで詳細が確認できる。
